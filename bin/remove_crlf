#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

function printUsage() {
  console.log('Usage: remove_crlf <file-or-directory>');
  console.log('');
  console.log('Converts CRLF line endings to LF (removes ^M characters).');
  console.log('If a directory is provided, processes all files recursively.');
  process.exit(1);
}

function removeCRLF(content) {
  return content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
}

function processFile(filePath) {
  try {
    const content = fs.readFileSync(filePath, 'utf-8');
    const cleaned = removeCRLF(content);

    if (content !== cleaned) {
      fs.writeFileSync(filePath, cleaned, 'utf-8');
      console.log(`Cleaned: ${filePath}`);
      return 1;
    }
    return 0;
  } catch (err) {
    console.error(`Error processing ${filePath}: ${err.message}`);
    return 0;
  }
}

function processDirectory(dirPath) {
  let count = 0;
  const items = fs.readdirSync(dirPath);

  items.forEach(item => {
    // Skip hidden files and symlinks
    if (item.startsWith('.')) {
      return;
    }

    const fullPath = path.join(dirPath, item);

    try {
      const stat = fs.statSync(fullPath);

      if (stat.isDirectory()) {
        count += processDirectory(fullPath);
      } else if (stat.isFile()) {
        count += processFile(fullPath);
      }
    } catch (err) {
      // Skip files that can't be accessed (broken symlinks, etc.)
      console.warn(`Skipping ${fullPath}: ${err.message}`);
    }
  });

  return count;
}

function main() {
  const args = process.argv.slice(2);

  if (args.length !== 1) {
    printUsage();
  }

  const target = args[0];

  if (!fs.existsSync(target)) {
    console.error(`Error: '${target}' not found`);
    process.exit(1);
  }

  const stat = fs.statSync(target);
  let count = 0;

  if (stat.isDirectory()) {
    console.log(`Processing directory: ${target}\n`);
    count = processDirectory(target);
  } else {
    count = processFile(target);
  }

  console.log(`\nDone! Cleaned ${count} file(s).`);
}

main();
